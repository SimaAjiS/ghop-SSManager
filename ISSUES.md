# 開発タスク一覧

## Issue 1: 一般ユーザー向けデータ閲覧画面（ユーザービュー）の新規実装

**概要**
現在の管理者向けマスター管理画面とは別に、一般ユーザーが日常業務でデータを参照するための専用画面を実装する。

**背景**
現在は全テーブルを管理する「マスター画面」のみが存在するが、一般ユーザーには情報過多であり、かつ誤操作のリスクもあるため、必要な情報のみを表示する閲覧専用画面が必要である。

**詳細要件**

- 管理者画面（Master View）とユーザー画面（User View）の分離
- ユーザー画面は「閲覧」を主目的とし、編集機能は持たせない（または制限する）
- ユーザーにとって見やすいレイアウト（ダッシュボード形式や、特定の業務フローに沿った表示など）

**タスク**

- [x] ユーザー画面用のルート作成（例: `/user`）
- [x] ユーザー向けトップページのデザイン・実装
- [x] 必要なデータのみを取得・表示する API またはフィルタリング処理の実装
- [x] ナビゲーションへのユーザー画面リンク追加

**結果**

- `/user` ルートを作成し、ユーザー専用のダッシュボード画面を実装しました。
- **デバイスリスト**: `MT_device` と `MT_spec_sheet` を結合した業務に直結するデバイス仕様一覧をデフォルト表示。
- **マスターテーブル閲覧**: 必要に応じて全マスターテーブルにアクセス可能なビューも用意。
- トップナビゲーションバーで Master View と User View を切り替え可能。
- ソート機能を改善し、空白値を常に最後に配置することで、データのあるレコードを優先的に表示。

## Issue 2: マスターデータのデータ型定義および主キー設定の適正化

**概要**
データベース上の各カラムに対し、適切なデータ型（数値、日付など）と主キー（Primary Key）を正しく設定・管理できるようにする。

**背景**
現状のインポート処理では、Excel からのデータ取り込み時に多くのカラムが「テキスト型（TEXT）」として定義されている可能性が高い。これにより、数値のソートが正しく行われない、日付計算ができない、データの整合性が保てない等の問題が発生する恐れがある。また、主キーが明確でないとレコードの特定やリレーションの構築に支障をきたす。

**詳細要件**

- **データ型の適正化**: 数値は数値型、日付は日付型として DB に格納する。
- **主キーの設定**: 各テーブルに対し、ユニークな ID または特定のカラムを主キーとして設定するルールを確立する。
- **スキーマ管理**: Excel のデータから推論するだけでなく、必要に応じて型定義を指定できる仕組みを検討する。

**タスク**

- [x] 現状の DB スキーマ（各カラムの型）の調査・確認
- [x] インポートスクリプト（`scripts/import_data.py` 等）における型推論ロジックの改善
- [x] 主キー（Primary Key）の自動付与または指定ルールの実装
- [x] 数値・日付データのソートや検索が正しく動作することの検証

**結果**

- `backend/schema.py` を作成し、SQLAlchemy を用いて全テーブルのスキーマ（型、主キー）を厳密に定義しました。
- インポートスクリプトを修正し、定義されたスキーマに基づいてテーブルを再作成するようにしました。
- Excel データ内の不正な数値（"Dummy", "A" 等）は `NaN` (NULL) として取り込むようにし、API エラー（500 Error）およびフロントエンドの Network Error を解消しました。
- `MT_device` (type), `MT_spec_sheet` (sheet_no) を主キーとして設定し、他は `id` (自動採番) を主キーとしました。

## Issue 3: 認証・認可（ログイン機能）の実装

**概要**
システムへのアクセス制御を行い、管理者と一般ユーザーで利用できる機能を制限する。

**背景**
Issue 1 でユーザー画面と管理者画面を分ける方針となったが、URL を知っていれば誰でも管理者画面にアクセスできてしまう状態はセキュリティ上好ましくない。また、誰が操作しているかを特定するためにも認証機能が必要である。

**詳細要件**

- **ログイン画面**: ユーザー名/パスワード等による認証。
- **権限管理 (Role-Based Access Control)**:
  - **Admin**: データインポート、全テーブル閲覧、システム設定が可能。
  - **User**: 許可されたビューの閲覧のみ可能。
- **セッション管理**: ログイン状態の維持とログアウト機能。

**タスク**

- [ ] ユーザー管理テーブルの作成
- [ ] JWT またはセッションベースの認証 API の実装
- [ ] フロントエンドへのログイン画面追加と保護ルート（Protected Routes）の実装

## Issue 4: データのバリデーションと整合性チェックの強化

**概要**
データの品質を保つため、インポート時およびデータ操作時に厳密なチェックを行う。

**背景**
Excel データの入力ミスやフォーマット違反を防ぐため、システム側でルールに基づいたバリデーションを行う必要がある。

**詳細要件**

- **必須チェック**: 必須項目の欠損検知。
- **型チェック**: 数値項目に文字が入っていないか等。
- **参照整合性 (Foreign Key)**: マスタ間のリレーションが正しいか（例: 存在しない部署コードが社員マスタに含まれていないか）のチェック。
- **エラーレポート**: インポート時に不備があった場合、具体的な行番号とエラー内容をユーザーに通知する。

**タスク**

- [ ] バリデーションルールの定義方法の検討（設定ファイルやスキーマ定義）
- [ ] インポート処理へのバリデーションロジック追加
- [ ] エラーログ出力・表示機能の実装

## Issue 5: データの変更履歴管理（監査ログ）

**概要**
「いつ」「誰が」「何をしたか」を記録し、追跡可能にする。

**背景**
マスタデータがいつ更新されたのか、意図しない変更が行われていないかを確認するために、操作ログが必要となる。

**詳細要件**

- **インポート履歴**: 誰がいつ Excel インポートを実行したか、その結果（成功/失敗、件数）を記録。
- **データ履歴**: （将来的に画面編集を入れる場合）レコードごとの変更履歴。
- **履歴閲覧画面**: 管理者がログを確認できる画面。

**タスク**

- [ ] ログ保存用テーブルの設計
- [ ] インポート処理および主要アクションへのログ出力処理の追加
- [ ] ログ閲覧画面の実装

## Issue 6: 検索・フィルタリング機能の高度化とエクスポート

**概要**
蓄積されたデータをより活用しやすくするための機能強化。

**背景**
単純なキーワード検索だけでなく、複合条件での絞り込みや、結果の二次利用（Excel/CSV ダウンロード）が業務上求められることが多い。

**詳細要件**

- **詳細検索**: カラムごとのフィルタリング（範囲指定、完全一致/部分一致など）。
- **エクスポート**: 表示中のデータ（検索結果含む）を CSV または Excel 形式でダウンロードする機能。

**タスク**

- [ ] バックエンドのクエリパラメータ処理の拡張（フィルタリング機能強化）
- [ ] フロントエンドへの詳細検索 UI 追加
- [ ] CSV/Excel エクスポート API の実装

## Issue 7: 大量データ対応（ページネーション・パフォーマンス最適化）

**概要**
データ量が増加しても快適に動作するようにパフォーマンスを最適化する。

**背景**
現在は全件取得を行っている可能性があるが、レコード数が数万件を超えるとブラウザの動作が重くなるため、サーバーサイドページネーション等が必要になる。

**詳細要件**

- **サーバーサイドページネーション**: 一度に全件ではなく、1 ページ分（例: 50 件）ずつデータを取得する。
- **インデックス最適化**: 検索頻度の高いカラムへのインデックス付与。

**タスク**

- [ ] バックエンド API のページネーション対応
- [ ] フロントエンドのデータテーブルコンポーネントの改修（ページ送り機能追加）
